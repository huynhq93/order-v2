<!DOCTYPE html>
<html>
<head>
  <title>Hóa đơn Ship - Template</title>
  <meta charset="UTF-8">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Arial', sans-serif; 
      margin: 0;
      padding: 0;
      background: white;
    }
    
    .bill-container {
      width: 886px;
      height: 591px;
      margin: 0 auto;
      background-image: url('./image/ship.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      overflow: hidden;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      background-color: white;
    }
    
    .overlay-content {
      position: absolute;
      width: 100%;
      height: 100%;
      color: #000;
      font-weight: bold;
    }
    
    /* Người nhận - vị trí chính xác theo hình */
    .customer-name {
      position: absolute;
      top: 221px;
      left: 570px;
      font-size: 25px;
      font-weight: bold;
      color: #000;
      max-width: 271px;
      text-align: left;
      word-wrap: break-word;
    }
    
    /* Số điện thoại - vị trí theo hình */
    .customer-phone {
      position: absolute;
      top: 273px;
      left: 590px;
      font-size: 25px;
      font-weight: bold;
      color: #000;
      max-width: 180px;
      text-align: left;
    }
    
    /* Địa chỉ - vị trí theo hình */
    .customer-address {
      position: absolute;
      top: 317px;
      left: 534px;
      font-size: 25px;
      font-weight: bold;
      color: #000;
      max-width: 310px;
      text-align: left;
      line-height: 50px; /* 25px font-size + 20px spacing = 45px */
    }
    
    /* Mã vận đơn - vị trí theo hình */
    .order-code {
      position: absolute;
      top: 275px;
      left: 540px;
      font-size: 25px;
      font-weight: bold;
      color: #000;
      max-width: 180px;
      text-align: left;
    }
    
    /* Tổng cộng - vị trí theo hình */
    .total-amount {
      position: absolute;
      top: 483px;
      left: 650px;
      font-size: 25px;
      font-weight: bold;
      color: #000;
      max-width: 180px;
      text-align: left;
    }
    
    @media print {
      body { 
        margin: 0; 
        padding: 0;
        background: white;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .bill-container { 
        width: 886px; 
        height: 591px;
        margin: 0;
        page-break-after: always;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        background-size: cover !important;
        background-position: center !important;
      }
      @page {
        size: 886px 591px;
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="bill-container">
    <div class="overlay-content">
      <!-- Người nhận -->
      <div class="customer-name" id="customer-name">
        <!-- [TÊN KHÁCH HÀNG] -->
      </div>
      
      <!-- Số điện thoại -->
      <div class="customer-phone" id="customer-phone">
        <!-- [SỐ ĐIỆN THOẠI] -->
      </div>
      
      <!-- Địa chỉ (để trống cho người dùng ghi tay) -->
      <div class="customer-address" id="customer-address">
        <!-- Để trống -->
      </div>
      
      <!-- Mã vận đơn -->
      <!-- <div class="order-code" id="order-code">
        [MÃ VẬN ĐƠN]
      </div> -->
      
      <!-- Tổng cộng -->
      <div class="total-amount" id="total-amount">
        <!-- [TỔNG CỘNG] -->
      </div>
    </div>
  </div>

  <script>
    // Function để tách số điện thoại và địa chỉ
    function parsePhoneAndAddress(contactInfo) {
      if (!contactInfo) {
        return { phone: '', address: '' };
      }
      
      // Regex để tìm số điện thoại Việt Nam (10-11 số)
      // Patterns: 0xxxxxxxxx hoặc +84xxxxxxxxx hoặc 84xxxxxxxxx
      const phonePatterns = [
        /(\+84|84)?0?\d{9,10}/g,  // Số điện thoại VN
        /\d{10,11}/g              // Backup: chuỗi 10-11 số liên tiếp
      ];
      
      let phone = '';
      let address = contactInfo;
      
      // Thử các pattern để tìm số điện thoại
      for (const pattern of phonePatterns) {
        const matches = contactInfo.match(pattern);
        if (matches && matches.length > 0) {
          phone = matches[0];
          // Loại bỏ số điện thoại khỏi chuỗi để lấy địa chỉ
          address = contactInfo.replace(phone, '').trim();
          // Loại bỏ các ký tự phân cách thừa ở đầu/cuối
          address = address.replace(/^[\s,\-_|\.]+|[\s,\-_|\.]+$/g, '').trim();
          break;
        }
      }
      
      return {
        phone: phone || contactInfo,  // Nếu không tìm thấy số thì hiển thị toàn bộ
        address: address || ''        // Địa chỉ có thể để trống
      };
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Function để cập nhật thông tin từ parent window
    function updateBillInfo(data) {
      // Tách số điện thoại và địa chỉ
      const contactInfo = parsePhoneAndAddress(data.customerPhone);
      
      document.getElementById('customer-name').textContent = data.customerName;
      document.getElementById('customer-phone').textContent = contactInfo.phone;
      document.getElementById('customer-address').textContent = contactInfo.address;
    //   document.getElementById('order-code').textContent = data.orderCode;
      document.getElementById('total-amount').textContent = data.totalAmount;
    }

    // Function để download image
    function downloadAsImage(data) {
      const container = document.querySelector('.bill-container');
      
      html2canvas(container, {
        width: 886,
        height: 591,
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        logging: false
      }).then(function(canvas) {
        // Tạo tên file theo format: tenkhachhang_ngaythangnam_giophutgiay
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const second = String(now.getSeconds()).padStart(2, '0');
        
        const customerName = data.customerName.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
        const fileName = `${customerName}_${year}${month}${day}_${hour}${minute}${second}.png`;
        
        // Tạo link download
        const link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png', 1.0);
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Thông báo cho parent window
        if (window.opener) {
          window.opener.postMessage({
            type: 'DOWNLOAD_COMPLETED'
          }, '*');
        }
        
        // Đóng cửa sổ ngay lập tức
        window.close();
      }).catch(function(error) {
        console.error('Error generating image:', error);
        alert('Có lỗi xảy ra khi tạo hình ảnh');
      });
    }

    // Listen for message từ parent window
    window.addEventListener('message', function(event) {
      if (event.data.type === 'UPDATE_BILL_INFO') {
        updateBillInfo(event.data.data);
      } else if (event.data.type === 'DOWNLOAD_AS_IMAGE') {
        // Đợi một chút để đảm bảo background image đã load
        setTimeout(() => {
          downloadAsImage(event.data.data);
        }, 500);
      } else if (event.data.type === 'PRINT_BILL') {
        window.print();
      }
    });

    // Đảm bảo background image đã load
    window.addEventListener('load', function() {
      const img = new Image();
      img.onload = function() {
        console.log('Background image loaded successfully');
      };
      img.src = './image/ship.jpeg';
    });
  </script>
</body>
</html>
